kind: Network
name: internet
spec:
  internal: false
  use-nat: true
  addresses:
  - 10.0.0.1/24
---
kind: Network
name: core-to-s1
spec:
  internal: true
  use-nat: false
---
kind: Network
name: core-to-s2
spec:
  internal: true
  use-nat: false
---
kind: Network
name: core-to-ext
spec:
  internal: true
  use-nat: false
---
kind: Network
name: core-to-op
spec:
  internal: true
  use-nat: false
---
kind: Network
name: s1-to-r0-1
spec:
  internal: true
  use-nat: false
---
kind: Network
name: s1-to-r0-2
spec:
  internal: true
  use-nat: false
---
kind: Network
name: s1-to-r1-1
spec:
  internal: true
  use-nat: false
---
kind: Network
name: s1-to-r1-2
spec:
  internal: true
  use-nat: false
---
kind: Network
name: s2-to-r0-1
spec:
  internal: true
  use-nat: false
---
kind: Network
name: s2-to-r0-2
spec:
  internal: true
  use-nat: false
---
kind: Network
name: s2-to-r1-1
spec:
  internal: true
  use-nat: false
---
kind: Network
name: s2-to-r1-2
spec:
  internal: true
  use-nat: false
---
kind: Network
name: r0-node1
spec:
  internal: true
  use-nat: false
---
kind: Network
name: r0-node2
spec:
  internal: true
  use-nat: false
---
kind: Network
name: r1-node1
spec:
  internal: true
  use-nat: false
---
kind: Network
name: r1-node2
spec:
  internal: true
  use-nat: false
---
kind: Image
name: coreos-image
spec:
  url: https://stable.release.core-os.net/amd64-usr/current/coreos_production_qemu_image.img.bz2
  compression: bzip2
---
kind: Image
name: ubuntu-image
spec:
  url: https://cloud-images.ubuntu.com/releases/bionic/release/ubuntu-18.04-server-cloudimg-amd64.img
---
kind: DataFolder
name: common-data
spec:
  files:
  - name: bird.aci
    file: cybozu-bird-2.0.aci
  - name: ubuntu-debug.aci
    file: cybozu-ubuntu-debug-18.04.aci
  - name: rkt-fetch
    file: rkt-fetch
  - name: bashrc
    file: bashrc
  - name: rkt.deb
    url: https://github.com/rkt/rkt/releases/download/v1.30.0/rkt_1.30.0-1_amd64.deb
---
kind: DataFolder
name: core-data
spec:
  files:
  - name: bird.conf
    file: bird_core.conf
---
kind: DataFolder
name: spine1-data
spec:
  files:
  - name: bird.conf
    file: bird_spine1.conf
---
kind: DataFolder
name: spine2-data
spec:
  files:
  - name: bird.conf
    file: bird_spine2.conf
---
kind: DataFolder
name: rack0-tor1-data
spec:
  files:
  - name: bird.conf
    file: bird_rack0-tor1.conf
---
kind: DataFolder
name: rack0-tor2-data
spec:
  files:
  - name: bird.conf
    file: bird_rack0-tor2.conf
---
kind: DataFolder
name: rack0-bird-data
spec:
  files:
  - name: bird.conf
    file: bird_rack0-node.conf
---
kind: DataFolder
name: rack1-tor1-data
spec:
  files:
  - name: bird.conf
    file: bird_rack1-tor1.conf
---
kind: DataFolder
name: rack1-tor2-data
spec:
  files:
  - name: bird.conf
    file: bird_rack1-tor2.conf
---
kind: DataFolder
name: rack1-bird-data
spec:
  files:
  - name: bird.conf
    file: bird_rack1-node.conf
---
kind: DataFolder
name: ext-vm-data
spec:
  files:
  - name: bird.conf
    file: bird_vm.conf
---
kind: DataFolder
name: operation-data
spec:
  dir: operation
---
kind: Node
name: rack0-boot
spec:
  interfaces:
  - r0-node1
  - r0-node2
  volumes:
  - kind: image
    name: root
    spec:
      image: ubuntu-image
      copy-on-write: true
  - kind: vvfat
    name: common
    spec:
      folder: common-data
      copy-on-write: false
  - kind: vvfat
    name: local
    spec:
      folder: rack0-bird-data
      copy-on-write: false
  - kind: localds
    name: seed
    spec:
      user-data: seed_rack0-boot.yml
      network-config: network.yml
      copy-on-write: false
  - kind: raw
    name: data
    spec:
      size: 30G
      copy-on-write: false
  resources:
    cpu: "2"
    memory: 2G
---
kind: Node
name: rack0-cs1
spec:
  interfaces:
  - r0-node1
  - r0-node2
  volumes:
  - kind: raw
    name: root
    spec:
      size: 30G
      copy-on-write: false
  resources:
    cpu: "2"
    memory: 2G
  bios: uefi
---
kind: Node
name: rack0-cs2
spec:
  interfaces:
  - r0-node1
  - r0-node2
  volumes:
  - kind: raw
    name: root
    spec:
      size: 30G
      copy-on-write: false
  resources:
    cpu: "2"
    memory: 2G
  bios: uefi
---
kind: Node
name: rack1-boot
spec:
  interfaces:
  - r1-node1
  - r1-node2
  volumes:
  - kind: image
    name: root
    spec:
      image: ubuntu-image
      copy-on-write: true
  - kind: vvfat
    name: common
    spec:
      folder: common-data
      copy-on-write: false
  - kind: vvfat
    name: local
    spec:
      folder: rack1-bird-data
      copy-on-write: false
  - kind: localds
    name: seed
    spec:
      user-data: seed_rack1-boot.yml
      network-config: network.yml
      copy-on-write: false
  - kind: raw
    name: data
    spec:
      size: 30G
      copy-on-write: false
  resources:
    cpu: "2"
    memory: 2G
---
kind: Node
name: rack1-cs1
spec:
  interfaces:
  - r1-node1
  - r1-node2
  volumes:
  - kind: raw
    name: root
    spec:
      size: 30G
      copy-on-write: false
  resources:
    cpu: "2"
    memory: 2G
  bios: uefi
---
kind: Node
name: rack1-cs2
spec:
  interfaces:
  - r1-node1
  - r1-node2
  volumes:
  - kind: raw
    name: root
    spec:
      size: 30G
      copy-on-write: false
  resources:
    cpu: "2"
    memory: 2G
  bios: uefi
---
kind: Node
name: rack1-ss1
spec:
  interfaces:
  - r1-node1
  - r1-node2
  volumes:
  - kind: raw
    name: root
    spec:
      size: 30G
      copy-on-write: false
  resources:
    cpu: "1"
    memory: 1G
  bios: uefi
---
kind: Node
name: rack1-ss2
spec:
  interfaces:
  - r1-node1
  - r1-node2
  volumes:
  - kind: raw
    name: root
    spec:
      size: 30G
      copy-on-write: false
  resources:
    cpu: "1"
    memory: 1G
  bios: uefi
---
kind: Pod
name: core
spec:
  init-scripts:
  - setup-iptables
  interfaces:
  - network: internet
    addresses:
    - 10.0.0.2/24
  - network: core-to-s1
    addresses:
    - 10.0.2.0/31
  - network: core-to-s2
    addresses:
    - 10.0.2.2/31
  - network: core-to-ext
    addresses:
    - 10.0.3.1/24
  - network: core-to-op
    addresses:
    - 10.0.4.1/24
  volumes:
  - name: config
    kind: host
    folder: core-data
    readonly: true
  - name: run
    kind: empty
    readonly: false
  apps:
  - name: bird
    image: docker://quay.io/cybozu/bird:2.0
    readonly-rootfs: true
    caps-retain:
    - CAP_NET_ADMIN
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    mount:
    - volume: config
      target: /etc/bird
    - volume: run
      target: /run/bird
  - name: debug
    image: docker://quay.io/cybozu/ubuntu-debug:18.04
    readonly-rootfs: true
---
kind: Pod
name: spine1
spec:
  interfaces:
  - network: core-to-s1
    addresses:
    - 10.0.2.1/31
  - network: s1-to-r0-1
    addresses:
    - 10.0.1.0/31
  - network: s1-to-r0-2
    addresses:
    - 10.0.1.2/31
  - network: s1-to-r1-1
    addresses:
    - 10.0.1.4/31
  - network: s1-to-r1-2
    addresses:
    - 10.0.1.6/31
  volumes:
  - name: config
    kind: host
    folder: spine1-data
    readonly: true
  - name: run
    kind: empty
    readonly: false
  apps:
  - name: bird
    image: docker://quay.io/cybozu/bird:2.0
    readonly-rootfs: true
    caps-retain:
    - CAP_NET_ADMIN
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    mount:
    - volume: config
      target: /etc/bird
    - volume: run
      target: /run/bird
  - name: debug
    image: docker://quay.io/cybozu/ubuntu-debug:18.04
    readonly-rootfs: true
---
kind: Pod
name: spine2
spec:
  interfaces:
  - network: core-to-s2
    addresses:
    - 10.0.2.3/31
  - network: s2-to-r0-1
    addresses:
    - 10.0.1.8/31
  - network: s2-to-r0-2
    addresses:
    - 10.0.1.10/31
  - network: s2-to-r1-1
    addresses:
    - 10.0.1.12/31
  - network: s2-to-r1-2
    addresses:
    - 10.0.1.14/31
  volumes:
  - name: config
    kind: host
    folder: spine2-data
    readonly: true
  - name: run
    kind: empty
    readonly: false
  apps:
  - name: bird
    image: docker://quay.io/cybozu/bird:2.0
    readonly-rootfs: true
    caps-retain:
    - CAP_NET_ADMIN
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    mount:
    - volume: config
      target: /etc/bird
    - volume: run
      target: /run/bird
  - name: debug
    image: docker://quay.io/cybozu/ubuntu-debug:18.04
    readonly-rootfs: true
---
kind: Pod
name: rack0-tor1
spec:
  interfaces:
  - network: s1-to-r0-1
    addresses:
    - 10.0.1.1/31
  - network: s2-to-r0-1
    addresses:
    - 10.0.1.9/31
  - network: r0-node1
    addresses:
    - 10.69.0.65/26
  volumes:
  - name: config
    kind: host
    folder: rack0-tor1-data
    readonly: true
  - name: run
    kind: empty
    readonly: false
  apps:
  - name: bird
    image: docker://quay.io/cybozu/bird:2.0
    readonly-rootfs: true
    caps-retain:
    - CAP_NET_ADMIN
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    mount:
    - volume: config
      target: /etc/bird
    - volume: run
      target: /run/bird
  - name: debug
    image: docker://quay.io/cybozu/ubuntu-debug:18.04
    readonly-rootfs: true
  - name: dhcp-relay
    image: docker://quay.io/cybozu/dnsmasq:2.79
    readonly-rootfs: true
    args:
    - --log-queries
    - --log-dhcp
    - --no-daemon
    - --dhcp-relay
    - 10.69.0.65,10.69.0.3
    - --dhcp-relay
    - 10.69.0.65,10.69.0.195
    caps-retain:
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    - CAP_NET_BROADCAST
---
kind: Pod
name: rack0-tor2
spec:
  interfaces:
  - network: s1-to-r0-2
    addresses:
    - 10.0.1.3/31
  - network: s2-to-r0-2
    addresses:
    - 10.0.1.11/31
  - network: r0-node2
    addresses:
    - 10.69.0.129/26
  volumes:
  - name: config
    kind: host
    folder: rack0-tor2-data
    readonly: true
  - name: run
    kind: empty
    readonly: false
  apps:
  - name: bird
    image: docker://quay.io/cybozu/bird:2.0
    readonly-rootfs: true
    caps-retain:
    - CAP_NET_ADMIN
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    mount:
    - volume: config
      target: /etc/bird
    - volume: run
      target: /run/bird
  - name: debug
    image: docker://quay.io/cybozu/ubuntu-debug:18.04
    readonly-rootfs: true
  - name: dhcp-relay
    image: docker://quay.io/cybozu/dnsmasq:2.79
    readonly-rootfs: true
    args:
    - --log-queries
    - --log-dhcp
    - --no-daemon
    - --dhcp-relay
    - 10.69.0.129,10.69.0.3
    - --dhcp-relay
    - 10.69.0.129,10.69.0.195
    caps-retain:
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    - CAP_NET_BROADCAST
---
kind: Pod
name: rack1-tor1
spec:
  interfaces:
  - network: s1-to-r1-1
    addresses:
    - 10.0.1.5/31
  - network: s2-to-r1-1
    addresses:
    - 10.0.1.13/31
  - network: r1-node1
    addresses:
    - 10.69.1.1/26
  volumes:
  - name: config
    kind: host
    folder: rack1-tor1-data
    readonly: true
  - name: run
    kind: empty
    readonly: false
  apps:
  - name: bird
    image: docker://quay.io/cybozu/bird:2.0
    readonly-rootfs: true
    caps-retain:
    - CAP_NET_ADMIN
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    mount:
    - volume: config
      target: /etc/bird
    - volume: run
      target: /run/bird
  - name: debug
    image: docker://quay.io/cybozu/ubuntu-debug:18.04
    readonly-rootfs: true
  - name: dhcp-relay
    image: docker://quay.io/cybozu/dnsmasq:2.79
    readonly-rootfs: true
    args:
    - --log-queries
    - --log-dhcp
    - --no-daemon
    - --dhcp-relay
    - 10.69.1.1,10.69.0.3
    - --dhcp-relay
    - 10.69.1.1,10.69.0.195
    caps-retain:
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    - CAP_NET_BROADCAST
---
kind: Pod
name: rack1-tor2
spec:
  interfaces:
  - network: s1-to-r1-2
    addresses:
    - 10.0.1.7/31
  - network: s2-to-r1-2
    addresses:
    - 10.0.1.15/31
  - network: r1-node2
    addresses:
    - 10.69.1.65/26
  volumes:
  - name: config
    kind: host
    folder: rack1-tor2-data
    readonly: true
  - name: run
    kind: empty
    readonly: false
  apps:
  - name: bird
    image: docker://quay.io/cybozu/bird:2.0
    readonly-rootfs: true
    caps-retain:
    - CAP_NET_ADMIN
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    mount:
    - volume: config
      target: /etc/bird
    - volume: run
      target: /run/bird
  - name: debug
    image: docker://quay.io/cybozu/ubuntu-debug:18.04
    readonly-rootfs: true
  - name: dhcp-relay
    image: docker://quay.io/cybozu/dnsmasq:2.79
    readonly-rootfs: true
    args:
    - --log-queries
    - --log-dhcp
    - --no-daemon
    - --dhcp-relay
    - 10.69.1.65,10.69.0.3
    - --dhcp-relay
    - 10.69.1.65,10.69.0.195
    caps-retain:
    - CAP_NET_BIND_SERVICE
    - CAP_NET_RAW
    - CAP_NET_BROADCAST
---
kind: Pod
name: external
spec:
  init-scripts:
  - setup-default-gateway-external
  interfaces:
  - network: core-to-ext
    addresses:
    - 10.0.3.2/24
  apps:
  - name: ubuntu
    image: docker://quay.io/cybozu/ubuntu-debug:18.04
    readonly-rootfs: false
    exec: /bin/sleep
    args:
    - infinity
---
kind: Pod
name: operation
spec:
  init-scripts:
  - setup-default-gateway-operation
  interfaces:
  - network: core-to-op
    addresses:
    - 10.0.4.2/24
  volumes:
  - name: operation
    kind: host
    folder: operation-data
    readonly: false
  apps:
  - name: ubuntu
    image: docker://quay.io/cybozu/ubuntu-dev:18.04
    readonly-rootfs: false
    exec: /bin/sleep
    args:
    - infinity
    mount:
    - volume: operation
      target: /mnt
