kind: Network
name: ext-net
spec:
  internal: false
  use-nat: true
  addresses:
    - 10.0.0.1/24
---
kind: Network
name: s1-to-r0-1
spec:
  internal: true
---
kind: Network
name: s1-to-r0-2
spec:
  internal: true
---
kind: Network
name: s1-to-r1-1
spec:
  internal: true
---
kind: Network
name: s1-to-r1-2
spec:
  internal: true
---
kind: Network
name: s2-to-r0-1
spec:
  internal: true
---
kind: Network
name: s2-to-r0-2
spec:
  internal: true
---
kind: Network
name: s2-to-r1-1
spec:
  internal: true
---
kind: Network
name: s2-to-r1-2
spec:
  internal: true
---
kind: Network
name: r0-node1
spec:
  internal: true
---
kind: Network
name: r0-node2
spec:
  internal: true
---
kind: Network
name: r1-node1
spec:
  internal: true
---
kind: Network
name: r1-node2
spec:
  internal: true
---
kind: Image
name: coreos-image
spec:
  url: https://stable.release.core-os.net/amd64-usr/current/coreos_production_qemu_image.img.bz2
  compression: bzip2
---
kind: DataFolder
name: common-data
spec:
  files:
    - name: bird.aci
      file: cybozu-bird-2.0.aci
    - name: ubuntu-debug.aci
      file: cybozu-ubuntu-debug-18.04.aci
    - name: rkt-fetch
      file: rkt-fetch
    - name: bashrc
      file: bashrc
---
kind: DataFolder
name: spine1-data
spec:
  files:
    - name: setup-iptables
      file: setup-iptables
    - name: bird.conf
      file: bird_spine1.conf
---
kind: DataFolder
name: spine2-data
spec:
  files:
    - name: setup-iptables
      file: setup-iptables
    - name: bird.conf
      file: bird_spine2.conf
---
kind: DataFolder
name: rack0-tor1-data
spec:
  files:
    - name: bird.conf
      file: bird_rack0-tor1.conf
---
kind: DataFolder
name: rack0-tor2-data
spec:
  files:
    - name: bird.conf
      file: bird_rack0-tor2.conf
---
kind: DataFolder
name: rack0-bird-data
spec:
  files:
    - name: setup-rp-filter
      file: setup-rp-filter
    - name: bird.conf
      file: bird_rack0-node.conf
---
kind: DataFolder
name: rack1-tor1-data
spec:
  files:
    - name: bird.conf
      file: bird_rack1-tor1.conf
---
kind: DataFolder
name: rack1-tor2-data
spec:
  files:
    - name: bird.conf
      file: bird_rack1-tor2.conf
---
kind: DataFolder
name: rack1-bird-data
spec:
  files:
    - name: setup-rp-filter
      file: setup-rp-filter
    - name: bird.conf
      file: bird_rack1-node.conf
---
kind: DataFolder
name: ext-vm-data
spec:
  files:
    - name: bird.conf
      file: bird_vm.conf
---
kind: Pod
name: spine1
spec:
  init-scripts:
    - setup-iptables
    - setup-rp-filter-0
  interfaces:
    - network: ext-net
      addresses:
        - 10.0.0.3/24
    - network: s1-to-r0-1
      addresses:
        - 10.0.1.0/31
    - network: s1-to-r0-2
      addresses:
        - 10.0.1.2/31
    - network: s1-to-r1-1
      addresses:
        - 10.0.1.4/31
    - network: s1-to-r1-2
      addresses:
        - 10.0.1.6/31
  volumes:
    - name: config
      kind: host
      folder: spine1-data
      readonly: true
    - name: run
      kind: empty
  apps:
    - name: bird
      image: docker://quay.io/cybozu/bird:2.0
      readonly-rootfs: true
      mount:
        - volume: config
          target: /etc/bird
        - volume: run
          target: /run/bird
      caps-retain:
        - CAP_NET_ADMIN
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
    - name: debug
      image: docker://quay.io/cybozu/ubuntu-debug:18.04
      readonly-rootfs: true
---
kind: Pod
name: spine2
spec:
  init-scripts:
    - setup-iptables
    - setup-rp-filter-0
  interfaces:
    - network: ext-net
      addresses:
        - 10.0.0.4/24
    - network: s2-to-r0-1
      addresses:
        - 10.0.1.8/31
    - network: s2-to-r0-2
      addresses:
        - 10.0.1.10/31
    - network: s2-to-r1-1
      addresses:
        - 10.0.1.12/31
    - network: s2-to-r1-2
      addresses:
        - 10.0.1.14/31
  volumes:
    - name: config
      kind: host
      folder: spine2-data
      readonly: true
    - name: run
      kind: empty
  apps:
    - name: bird
      image: docker://quay.io/cybozu/bird:2.0
      readonly-rootfs: true
      mount:
        - volume: config
          target: /etc/bird
        - volume: run
          target: /run/bird
      caps-retain:
        - CAP_NET_ADMIN
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
    - name: debug
      image: docker://quay.io/cybozu/ubuntu-debug:18.04
      readonly-rootfs: true
---
kind: Pod
name: rack0-tor1
spec:
  init-scripts:
    - setup-rp-filter-0
  interfaces:
    - network: s1-to-r0-1
      addresses:
        - 10.0.1.1/31
    - network: s2-to-r0-1
      addresses:
        - 10.0.1.9/31
    - network: r0-node1
      addresses:
        - 10.69.0.65/26
  volumes:
    - name: config
      kind: host
      folder: rack0-tor1-data
      readonly: true
    - name: run
      kind: empty
  apps:
    - name: bird
      image: docker://quay.io/cybozu/bird:2.0
      readonly-rootfs: true
      mount:
        - volume: config
          target: /etc/bird
        - volume: run
          target: /run/bird
      caps-retain:
        - CAP_NET_ADMIN
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
    - name: debug
      image: docker://quay.io/cybozu/ubuntu-debug:18.04
      readonly-rootfs: true
    - name: dhcp-relay
      image: docker://quay.io/cybozu/dnsmasq:2.79
      readonly-rootfs: true
      caps-retain:
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
        - CAP_NET_BROADCAST
      args:
        - "--no-daemon"
        - "--dhcp-relay"
        - "10.69.0.65,10.69.0.3"
        - "--dhcp-relay"
        - "10.69.0.65,10.69.0.195"
---
kind: Pod
name: rack0-tor2
spec:
  init-scripts:
    - setup-rp-filter-0
  interfaces:
    - network: s1-to-r0-2
      addresses:
        - 10.0.1.3/31
    - network: s2-to-r0-2
      addresses:
        - 10.0.1.11/31
    - network: r0-node2
      addresses:
        - 10.69.0.129/26
  volumes:
    - name: config
      kind: host
      folder: rack0-tor2-data
      readonly: true
    - name: run
      kind: empty
  apps:
    - name: bird
      image: docker://quay.io/cybozu/bird:2.0
      readonly-rootfs: true
      mount:
        - volume: config
          target: /etc/bird
        - volume: run
          target: /run/bird
      caps-retain:
        - CAP_NET_ADMIN
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
    - name: debug
      image: docker://quay.io/cybozu/ubuntu-debug:18.04
      readonly-rootfs: true
    - name: dhcp-relay
      image: docker://quay.io/cybozu/dnsmasq:2.79
      readonly-rootfs: true
      caps-retain:
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
        - CAP_NET_BROADCAST
      args:
        - "--no-daemon"
        - "--dhcp-relay"
        - "10.69.0.129,10.69.0.3"
        - "--dhcp-relay"
        - "10.69.0.129,10.69.0.195"
---
kind: Pod
name: rack1-tor1
spec:
  init-scripts:
    - setup-rp-filter-0
  interfaces:
    - network: s1-to-r1-1
      addresses:
        - 10.0.1.5/31
    - network: s2-to-r1-1
      addresses:
        - 10.0.1.13/31
    - network: r1-node1
      addresses:
        - 10.69.1.1/26
  volumes:
    - name: config
      kind: host
      folder: rack1-tor1-data
      readonly: true
    - name: run
      kind: empty
  apps:
    - name: bird
      image: docker://quay.io/cybozu/bird:2.0
      readonly-rootfs: true
      mount:
        - volume: config
          target: /etc/bird
        - volume: run
          target: /run/bird
      caps-retain:
        - CAP_NET_ADMIN
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
    - name: debug
      image: docker://quay.io/cybozu/ubuntu-debug:18.04
      readonly-rootfs: true
    - name: dhcp-relay
      image: docker://quay.io/cybozu/dnsmasq:2.79
      readonly-rootfs: true
      caps-retain:
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
        - CAP_NET_BROADCAST
      args:
        - "--no-daemon"
        - "--dhcp-relay"
        - "10.69.1.1,10.69.0.3"
        - "--dhcp-relay"
        - "10.69.1.1,10.69.0.195"
---
kind: Pod
name: rack1-tor2
spec:
  init-scripts:
    - setup-rp-filter-0
  interfaces:
    - network: s1-to-r1-2
      addresses:
        - 10.0.1.7/31
    - network: s2-to-r1-2
      addresses:
        - 10.0.1.15/31
    - network: r1-node2
      addresses:
        - 10.69.1.65/26
  volumes:
    - name: config
      kind: host
      folder: rack1-tor2-data
      readonly: true
    - name: run
      kind: empty
  apps:
    - name: bird
      image: docker://quay.io/cybozu/bird:2.0
      readonly-rootfs: true
      mount:
        - volume: config
          target: /etc/bird
        - volume: run
          target: /run/bird
      caps-retain:
        - CAP_NET_ADMIN
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
    - name: debug
      image: docker://quay.io/cybozu/ubuntu-debug:18.04
      readonly-rootfs: true
    - name: dhcp-relay
      image: docker://quay.io/cybozu/dnsmasq:2.79
      readonly-rootfs: true
      caps-retain:
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
        - CAP_NET_BROADCAST
      args:
        - "--no-daemon"
        - "--dhcp-relay"
        - "10.69.1.65,10.69.0.3"
        - "--dhcp-relay"
        - "10.69.1.65,10.69.0.195"
---
kind: Node
name: rack0-boot
spec:
  interfaces:
    - r0-node1
    - r0-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: common
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: rack0-bird-data
  ignition: rack0-boot.ign
  resources:
    cpu: 2
    memory: 2G
---
kind: Node
name: rack0-cs1
spec:
  interfaces:
    - r0-node1
    - r0-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: commoe
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: rack0-bird-data
  ignition: rack0-cs1.ign
  resources:
    cpu: 2
    memory: 2G
---
kind: Node
name: rack0-cs2
spec:
  interfaces:
    - r0-node1
    - r0-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: commoe
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: rack0-bird-data
  ignition: rack0-cs2.ign
  resources:
    cpu: 2
    memory: 2G
---
kind: Node
name: rack1-boot
spec:
  interfaces:
    - r1-node1
    - r1-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: common
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: rack1-bird-data
  ignition: rack1-boot.ign
  resources:
    cpu: 2
    memory: 2G
---
kind: Node
name: rack1-cs1
spec:
  interfaces:
    - r1-node1
    - r1-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: commoe
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: rack1-bird-data
  ignition: rack1-cs1.ign
  resources:
    cpu: 2
    memory: 2G
---
kind: Node
name: rack1-cs2
spec:
  interfaces:
    - r1-node1
    - r1-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: commoe
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: rack1-bird-data
  ignition: rack1-cs2.ign
  resources:
    cpu: 2
    memory: 2G
---
kind: Node
name: rack1-ss1
spec:
  interfaces:
    - r1-node1
    - r1-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: common
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: rack1-bird-data
  ignition: rack1-ss1.ign
  resources:
    cpu: 1
    memory: 1G
---
kind: Node
name: rack1-ss2
spec:
  interfaces:
    - r1-node1
    - r1-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: common
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: rack1-bird-data
  ignition: rack1-ss2.ign
  resources:
    cpu: 1
    memory: 1G
---
kind: Node
name: ext-vm
spec:
  interfaces:
    - ext-net
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: common
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: ext-vm-data
  ignition: ext-vm.ign
  resources:
    cpu: 2
    memory: 1G
