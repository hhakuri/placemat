kind: Network
name: ext-net
spec:
  internal: false
  use-nat: true
  addresses:
    - {{ .Network.External.Host }}
---
{{$racks := .Racks -}}
{{range $spine := .Spines -}}
{{range $rack := $racks -}}
kind: Network
name: {{$spine.ShortName}}-to-{{$rack.ShortName}}-1
spec:
  internal: true
---
kind: Network
name: {{$spine.ShortName}}-to-{{$rack.ShortName}}-2
spec:
  internal: true
---
{{end -}}
{{end -}}
{{range $rack := .Racks -}}
kind: Network
name: {{$rack.ShortName}}-node1
spec:
  internal: true
---
kind: Network
name: {{$rack.ShortName}}-node2
spec:
  internal: true
---
{{end -}}
kind: Image
name: coreos-image
spec:
  url: https://stable.release.core-os.net/amd64-usr/current/coreos_production_qemu_image.img.bz2
  compression: bzip2
---
kind: DataFolder
name: common-data
spec:
  files:
    - name: bird.aci
      file: cybozu-bird-2.0.aci
    - name: ubuntu-debug.aci
      file: cybozu-ubuntu-debug-18.04.aci
    - name: dnsmasq.aci
      file: cybozu-dnsmasq-2.79.aci
    - name: rkt-fetch
      file: rkt-fetch
    - name: bashrc
      file: bashrc
---
{{range $spine := .Spines -}}
kind: DataFolder
name: {{$spine.Name}}-data
spec:
  files:
    - name: setup-iptables
      file: setup-iptables
    - name: bird.conf
      file: bird_{{$spine.Name}}.conf
---
{{end -}}
{{range $rack := .Racks -}}
kind: DataFolder
name: {{$rack.Name}}-tor1-data
spec:
  files:
    - name: bird.conf
      file: bird_{{$rack.Name}}-tor1.conf
---
kind: DataFolder
name: {{$rack.Name}}-tor2-data
spec:
  files:
    - name: bird.conf
      file: bird_{{$rack.Name}}-tor2.conf
---
kind: DataFolder
name: {{$rack.Name}}-bird-data
spec:
  files:
    - name: setup-rp-filter
      file: setup-rp-filter
    - name: bird.conf
      file: bird_{{$rack.Name}}-node.conf
---
{{end -}}
kind: DataFolder
name: ext-vm-data
spec:
  files:
    - name: bird.conf
      file: bird_vm.conf
---
{{$racks := .Racks -}}
{{range $spine := .Spines -}}
kind: Pod
name: {{$spine.Name}}
spec:
  init-scripts:
    - setup-iptables
    - setup-rp-filter-0
  interfaces:
    - network: ext-net
      addresses:
        - {{$spine.ExtnetAddress}}
    {{- range $i, $rack := $racks}}
    - network: {{$spine.ShortName}}-to-{{$rack.ShortName}}-1
      addresses:
        - {{$spine.ToR1Address $i}}
    - network: {{$spine.ShortName}}-to-{{$rack.ShortName}}-2
      addresses:
        - {{$spine.ToR2Address $i}}
    {{- end}}
  volumes:
    - name: config
      kind: host
      folder: {{$spine.Name}}-data
      readonly: true
    - name: run
      kind: empty
  apps:
    - name: bird
      image: docker://quay.io/cybozu/bird:2.0
      readonly-rootfs: true
      mount:
        - volume: config
          target: /etc/bird
        - volume: run
          target: /run/bird
      caps-retain:
        - CAP_NET_ADMIN
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
    - name: debug
      image: docker://quay.io/cybozu/ubuntu-debug:18.04
      readonly-rootfs: true
---
{{end -}}
{{$spines := .Spines -}}
{{$racks := .Racks -}}
{{range $rack := .Racks -}}
kind: Pod
name: {{$rack.Name}}-tor1
spec:
  init-scripts:
    - setup-rp-filter-0
  interfaces:
    {{range $spineIdx, $spine := $spines -}}
    - network: {{$spine.ShortName}}-to-{{$rack.ShortName}}-1
      addresses:
        - {{index $rack.ToR1SpineAddresses $spineIdx}}
    {{end -}}
    - network: {{$rack.ShortName}}-node1
      addresses:
        - {{$rack.ToR1NodeAddress}}
  volumes:
    - name: config
      kind: host
      folder: {{$rack.Name}}-tor1-data
      readonly: true
    - name: run
      kind: empty
  apps:
    - name: bird
      image: docker://quay.io/cybozu/bird:2.0
      readonly-rootfs: true
      mount:
        - volume: config
          target: /etc/bird
        - volume: run
          target: /run/bird
      caps-retain:
        - CAP_NET_ADMIN
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
    - name: debug
      image: docker://quay.io/cybozu/ubuntu-debug:18.04
      readonly-rootfs: true
    - name: dhcp-relay
      image: docker://quay.io/cybozu/dnsmasq:2.79
      readonly-rootfs: true
      caps-retain:
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
        - CAP_NET_BROADCAST
      args:
        - "--log-queries"
        - "--log-dhcp"
        - "--no-daemon"
        {{- range $rack2 := $racks}}
        - "--dhcp-relay"
        - "{{$rack.ToR1NodeAddress.IP}},{{$rack2.BootNode.Node0Address.IP}}"
        {{- end }}
---
kind: Pod
name: {{$rack.Name}}-tor2
spec:
  init-scripts:
    - setup-rp-filter-0
  interfaces:
    {{range $spineIdx, $spine := $spines -}}
    - network: {{$spine.ShortName}}-to-{{$rack.ShortName}}-2
      addresses:
        - {{index $rack.ToR2SpineAddresses $spineIdx}}
    {{end -}}
    - network: {{$rack.ShortName}}-node2
      addresses:
        - {{$rack.ToR2NodeAddress}}
  volumes:
    - name: config
      kind: host
      folder: {{$rack.Name}}-tor2-data
      readonly: true
    - name: run
      kind: empty
  apps:
    - name: bird
      image: docker://quay.io/cybozu/bird:2.0
      readonly-rootfs: true
      mount:
        - volume: config
          target: /etc/bird
        - volume: run
          target: /run/bird
      caps-retain:
        - CAP_NET_ADMIN
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
    - name: debug
      image: docker://quay.io/cybozu/ubuntu-debug:18.04
      readonly-rootfs: true
    - name: dhcp-relay
      image: docker://quay.io/cybozu/dnsmasq:2.79
      readonly-rootfs: true
      caps-retain:
        - CAP_NET_BIND_SERVICE
        - CAP_NET_RAW
        - CAP_NET_BROADCAST
      args:
        - "--log-queries"
        - "--log-dhcp"
        - "--no-daemon"
        {{- range $rack2 := $racks}}
        - "--dhcp-relay"
        - "{{$rack.ToR2NodeAddress.IP}},{{$rack2.BootNode.Node0Address.IP}}"
        {{- end }}
---
{{end -}}
{{$csSpec := .CS -}}
{{$ssSpec := .SS -}}
{{$bootSpec := .Boot -}}
{{range $rack := .Racks -}}
kind: Node
name: {{$rack.Name}}-boot
spec:
  interfaces:
    - {{$rack.ShortName}}-node1
    - {{$rack.ShortName}}-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: common
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: {{$rack.Name}}-bird-data
  ignition: {{$rack.Name}}-boot.ign
  resources:
    cpu: {{$bootSpec.CPU}}
    memory: {{$bootSpec.Memory}}
---
{{range $csNode := $rack.CSList -}}
kind: Node
name: {{$rack.Name}}-{{$csNode.Name}}
spec:
  interfaces:
    - {{$rack.ShortName}}-node1
    - {{$rack.ShortName}}-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: commoe
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: {{$rack.Name}}-bird-data
  ignition: {{$rack.Name}}-{{$csNode.Name}}.ign
  resources:
    cpu: {{$csSpec.CPU}}
    memory: {{$csSpec.Memory}}
---
{{end -}}
{{range $ssNode := $rack.SSList -}}
kind: Node
name: {{$rack.Name}}-{{$ssNode.Name}}
spec:
  interfaces:
    - {{$rack.ShortName}}-node1
    - {{$rack.ShortName}}-node2
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: common
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: {{$rack.Name}}-bird-data
  ignition: {{$rack.Name}}-{{$ssNode.Name}}.ign
  resources:
    cpu: {{$ssSpec.CPU}}
    memory: {{$ssSpec.Memory}}
---
{{end -}}
{{end -}}
kind: Node
name: ext-vm
spec:
  interfaces:
    - ext-net
  volumes:
    - kind: image
      name: root
      spec:
        image: coreos-image
        copy-on-write: true
    - kind: vvfat
      name: common
      spec:
        folder: common-data
    - kind: vvfat
      name: local
      spec:
        folder: ext-vm-data
  ignition: ext-vm.ign
  resources:
    cpu: 2
    memory: 1G
